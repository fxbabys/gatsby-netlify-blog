---
title: HTTP协议
date: 2018-01-22 10:35:17
tags: HTTP
---

浏览公众号时看到一篇介绍HTTP较全的文章，这里做一个摘录总结，后续学习会不断完善改进~

### 简单介绍
- HTTP协议：超文本传输协议，用于从万维网服务器传输超文本到本地浏览器的传送协议，是互联网上应用最为广泛的一种网络协议，所有www文件都必须遵守的这个标准
- HTTP基于TCP/IP通信协议来传送数据（HTML文件、图片文件、查询结果等）
- HTTP是一个属于应用层的面向对象的协议，由于其简捷、快速的方式，适用于分布式超媒体信息系统。于1990年提出，不断地完善和扩展
- HTTP协议以客户端-服务端架构为上。浏览器作为HTTP客户端通过URL向HTTP服务端即Web服务器发送所有请求。Web服务器根据接收到的请求后，向客户端发送响应信息

### HTTP协议版本
- HTTP0.9是第一个版本，请求(Request)只有一行，比如：GET www.baidu.com
- HTTP1.0最早于1996年在网页中使用，只是使用一些较为简单的网页和网络请求上
- HTTP1.1在1999年开始广泛应用于现在的各大浏览器网络请求中，同时它也是当前使用最为广泛的协议

- HTTP1.1的升级部分
  - 缓存处理：HTTP1.0主要使用header里的If-Modified-Since,Expires来作为缓存判断的标准，而HTTP1.1则引入了更多的缓存控制策略如Entity tag,If-Unmodified-Since,If-Match,If-None-Match等更多可供选择的缓存头来控制缓存策略
  - 带宽优化及网络连接：HTTP1.0中存在浪费带宽的现象，比如客户端只是需要某个对象的一部分但  服务器却将整个对象传送过来了，并且不支持断点续传功能；HTTP1.1则在请求头引入了range头域，它允许只请求资源的某个部分，即返回码是206(Partial Content)  ，这样就方便了开发者自有的选择以便于充分利用带宽和连接
  - 错误通知的管理：HTTP1.1中新增了24个错误状态响应码，如409(Conflict)  表示请求的资源与资源的当前状态发生冲突，410(Gone)表示服务器上的某个资源被永久性的删除
  - Host头处理：HTTP1.0中认为每台服务器都绑定一个唯一的IP地址，因此请求消息中的URL并没有传递主机名(hostname),但随着虚拟主机技术的发展，一台物理服务器上可以存在多个虚拟主机，并且共享一个IP地址；HTTP1.1的请求消息和响应消息都应支持Host头域，并且请求消息中如果没有Host头域就会报告400(Bad Request)错误
  - 长连接：HTTP1.1支持长连接(PersistentConnection)和请求的流水线(Pipelining)处理，在一个TCP连接上可以传送多个HTTP请求和响应，减少了建立和关闭连接的消耗和延迟，在HTTP1.1中  默认开启Connection：Keep-alive,一定程度上弥补了HTTP1.0每次请求都要创建连接的缺点
  
- 如何建立连接(三次握手)
  HTTP是基于TCP协议的，浏览器最快也要在第三次握手时才能捎带HTTP请求报文，真正的建立连接，但是这些连接无法复用会导致每次请求都经历三次握手和慢启动，三次握手在高延迟的场景下影响较明显，慢启动则对文件类大请求影响较大
  - 第一次握手：客户端发送syn包(syn=j)到服务器，并进入SYN_SENT状态，等待服务器确认；
  SYN：同步序列编号
  - 第二次握手：服务器收到syn包，必须确认客户的SYN(ack=j+1),同时自己也发送一个SYN包(syn=k),即SYN+ACK包,此时服务器进入SYN_RECV状态
  - 第三次握手：客户端收到服务器的SYN+ACK包，向服务器发送确认包ACK(ack=k+1),此包发送完毕后，客户端和服务器进入ESTABLISHED(TCP连接成功)状态,完成三次握手
  
- 如何关闭连接(四次挥手)
  - 由于TCP连接是全双工的，因此每个方向都必须单独进行关闭。原则是当一方完成它的数据发送任务后就能发送一个FIN来终止这个方向的连接。收到一个FIN只意味着这一方向上没有数据流动，一个TCP连接在收到一个FIN后仍能发送数据。首先进行关闭的一方将执行主动关闭，另一方执行被动关闭

- TCP连接的拆除需要发送四个包，客户端或服务器均可主动发起挥手动作，在socket编程中，任何一方执行close()操作即可产生挥手操作
  - 客户端发送一个FIN，用来关闭客户端到服务器的数据传送
  - 服务器收到这个FIN，发回一个ACK，确认序号为收到的序号+1，和SYN一样，一个FIN将占用一个序号
  - 服务器关闭与客户端的连接，发送一个FIN给客户端
  - 客户端发回ACK报文确认，并将确认序号设置为收到序号+1

![](https://ws1.sinaimg.cn/large/e4336439gy1fnpbj3ksqmj20lp0lfjyu.jpg)

- 浏览器阻塞
  - 浏览器对于同一个域名，一般PC端浏览器针对单个域名的server同时建立6~8个连接，手机端的连接数则控制在4~6个(根据浏览器内核的不同可能会有所差异)，超过浏览器最大连接数限制，后续请求就会被阻塞

### HTTP2前述概念
- SPDY
  SPDY协议是Google提出的基于传输控制协议(TCP)的应用层协议，通过压缩、多路复用和优先级来缩短加载时间，是一种更快加速的内容传输协议，于2009年年中发布，Chrome、FireFox、Oprea已默认开启SPDY
- SPDY协议设定目标
  1. 页面加载时间降低50%
  2. 无需网站作者修改任何内容
  3. 最小化配置复杂度，无需变更网络基础设施
注：为了降低50%的页面加载时间，SPDY引入了一个新的二进制分帧数据层，以实现多向请求和响应、优先次序、最小化及消除不必要的网络延迟，目的是更有效地利用底层TCP连接

### HTTP2：SPDY升级版
- HTTP-WG在2012年初提议了HTTP2.0，并吸收SPDY的经验教训在此基础上制定官方标准
- HTTP2的主要目标是改进传输性能，更有效地利用网络资源，实现低延迟和高吞吐量
- HTTP2致力于突破上一代标准的性能限制，也是一个扩展，之所以要递增一个大版本，主要是因为改变了客户端与服务器之间交换数据的方式

- HTTP2如何提高效率
  - 二进制分帧：HTTP2.0所有帧都采用二进制编码
    - 帧：客户端与服务器通过交换帧来通信，帧是基于这个新协议通信的最小单位
    - 消息：指逻辑上的HTTP消息，比如请求、响应等，由一个或多个帧组成
    - 流：流是连接中的一个虚拟信道，可以承载双向的消息；每个流都有一个唯一的整数标识符
    ![](https://ws1.sinaimg.cn/large/e4336439gy1fnpbk79csjj20oh06ktbb.jpg)
  - 多路复用：允许通过单一的HTTP/2连接发起多重的请求-响应消息。有了新的分帧机制后，HTTP2不再依赖多个TCP连接去实现多流并行。每个数据流都拆分成很多互不依赖的帧，而这些帧可以交错(乱序发送)，还可以分优先级，最后再在另一端把它们重新组合。HTTP2.0连接都是持久化的，而且客户端与服务器之间只需要一个连接(一个域名一个连接)即可
  - 请求优先级：
    - 将HTTP消息分解为很多个独立的帧后，就可以通过优化这些帧的交错和传输顺序，每个流都可以带有一个31比特的优先值：0表示最高优先级，2的-31次方表示最低优先级
    - 服务器可以根据流的优先级，控制资源分配(CPU、内存、带宽)，而在响应数据准备好之后，优先将最高优先级的帧发送给客户端
    - HTTP2.0解决了所有低效的问题：浏览器可以在发现资源时立即分配请求，指定每个流的优先级，让服务器决定最优的响应次序，这样请求不用排队，既节省了时间也最大限度地利用了每个连接
  - header压缩：HTTP1.x的header带有大量信息，而且每次都要重复发送，HTTP2使用encoder来减少需要传输的header大小，通讯双方各自cache一份headerfields表，既避免了重复header的传输，又减小了需要传输的大小
  - 服务端推送：
    - 服务器可以对一个客户端请求发送多个响应并且服务器向客户端推送资源无需客户端明确地请求
    - HTTP2.0连接后，客户端与服务器交换SET-TINGS帧，借此可以限定双向并发的流的最大数量
    - 所有推送的资源都遵守同源策略。换句话说，服务器不能随便将第三方资源推送给客户端，而必须是经过双方确认猜想
    - 服务器必须遵循请求-响应的循环，只能借着对请求的响应推送资源
    - 服务端推送能把客户端所需要的资源伴随着index.html一起发送到客户端，省去了客户端重复请求的步骤

- HTTP2的多路复用与HTTP1.1的长连接复用有什么区别
  - HTTP1.0一次请求-响应，建立一个连接，用完关闭，每一个请求都要建立一个连接
  - HTTP1.1Pipeling解决方式为：若干个请求排队串行化单线程处理，后面的请求等待前面请求的返回才能获得执行机会，一旦有某请求超时等情况，后续请求只能被阻塞，毫无办法，即线头阻塞
  - HTTP2多个请求可同时在一个连接上并行执行，某个请求任务耗时严重也不会影响到其它连接的正常执行
  ![](https://ws1.sinaimg.cn/large/e4336439gy1fnpbl9djihj20kj0kqjyl.jpg)

### 如何应用到自己的项目
现有任何网站和应用，无需做任何修改都可以在HTTP2.0上跑起来，HTTP服务器必须运行HTTP2.0协议，但大部分用户都不会因此受影响，NGINX的话只要在配置文件中启动相应的协议就可以了
